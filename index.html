<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>行家牛排 線上點餐</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light">
  <style>
    .card{border-radius:1rem}.btn{border-radius:1rem}.badge{border-radius:999px}
    .container-slim{max-width:1200px}.mono{font-variant-numeric:tabular-nums}
    input,select,textarea,option,button{color-scheme:light}
    input,select,textarea{background:#fff!important;color:#0f172a!important;-webkit-text-fill-color:#0f172a;border-color:#cbd5e1}
    select option{background:#fff;color:#0f172a}
    .scroll-y{overflow-y:auto;-webkit-overflow-scrolling:touch}
  </style>
</head>

<body class="bg-slate-50 text-slate-900 selection:bg-slate-200 selection:text-slate-900">
<header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="mx-auto container-slim px-4 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-slate-900 text-white rounded-xl grid place-items-center text-lg font-bold select-none">店</div>
      <div>
        <div class="text-xl font-semibold">行家牛排 線上點餐</div>
        <div class="text-xs text-slate-500">營業時間: 17:00 - 22:00  ，  每週一、三公休 </div>
      </div>
    </div>
    <a href="#cart" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">購物車</a>
  </div>
</header>

<main class="mx-auto container-slim px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
  <section class="lg:col-span-2 space-y-8">
    <div class="space-y-3">
      <h2 class="text-lg font-semibold">豬肉</h2>
      <div id="porkList" class="grid grid-cols-2 gap-4"></div>
    </div>
    <div class="space-y-3">
      <h2 class="text-lg font-semibold">牛肉</h2>
      <div id="beefList" class="grid grid-cols-2 gap-4"></div>
    </div>
    <div class="space-y-3">
      <h2 class="text-lg font-semibold">雞肉</h2>
      <div id="chickenList" class="grid grid-cols-2 gap-4"></div>
    </div>
    <div class="space-y-3">
      <h2 class="text-lg font-semibold">海鮮</h2>
      <div id="seafoodList" class="grid grid-cols-2 gap-4"></div>
    </div>
    <div class="space-y-3">
      <h2 class="text-lg font-semibold">雙拼排餐</h2>
      <div id="comboList" class="grid grid-cols-2 gap-4"></div>
    </div>
    <div class="space-y-3">
      <h2 class="text-lg font-semibold">單點副食</h2>
      <div id="sidesList" class="grid grid-cols-2 gap-4"></div>
    </div>
  </section>

  <aside id="cart"
    class="space-y-6 lg:sticky lg:top-[88px] lg:max-h-[calc(100vh-120px)] lg:overflow-y-auto lg:pr-1"
    style="-webkit-overflow-scrolling: touch;">
    <div class="card bg-white p-5">
      <h2 class="text-lg font-semibold mb-4">購物車</h2>
      <div id="cartItems" class="space-y-3"></div>
      <div class="border-t pt-4 mt-4 flex items-center justify-between text-lg font-semibold">
        <div>總計</div>
        <div id="cartTotal" class="mono">$0</div>
      </div>
      <button id="clearCart" class="mt-3 w-full btn px-4 py-2 border border-slate-300 hover:bg-slate-100">清空購物車</button>
    </div>

    <div class="card bg-white p-5">
      <h2 class="text-lg font-semibold mb-4">取餐資訊</h2>
      <form id="checkoutForm" class="space-y-4" autocomplete="off">
        <div>
          <label class="text-sm text-slate-600">姓名</label>
          <input required id="customerName" type="text"
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900" />
        </div>
        <div>
          <label class="text-sm text-slate-600">電話</label>
          <input required id="customerPhone" type="tel" pattern="[0-9\-+\s]{8,}" placeholder="09xx-xxx-xxx"
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900" />
        </div>
        <button type="submit" class="w-full btn px-4 py-3 bg-slate-900 text-white hover:bg-slate-800">送出訂單</button>
        <p id="formError" class="text-sm text-red-600"></p>
      </form>
    </div>
  </aside>
</main>

<!-- 公告視窗 -->
<div id="noticeModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative z-10 mx-auto mt-20 w-[92%] max-w-xl card bg-white p-6">
    <h3 class="text-xl font-semibold">公告</h3>
    <ul class="mt-3 list-disc pl-5 space-y-2 text-slate-800">
      <li>僅限外帶！</li>
      <li>要內用勿點！</li>
      <li>取餐時間僅供參考，以現場作業為準！</li>
      <li>每週二,五,日，南科廠商21:30後，滿1500元可享外送服務！</li>
      <li>現場可以行動電子支付 （台灣pay, line pay, icash pay, 全支付, 街口支付）</li>
    </ul>
    <div class="mt-5 flex justify-end gap-3">
      <button id="closeNotice" class="btn px-4 py-2 bg-slate-900 text-white hover:bg-slate-800">我知道了</button>
    </div>
  </div>
</div>

<!-- 成功視窗 -->
<div id="successModal" class="fixed inset-0 z-40 hidden">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative z-10 mx-auto mt-24 w-[92%] max-w-xl card bg-white p-6">
    <h3 class="text-xl font-semibold mb-2">下單成功</h3>
    <p class="text-slate-700">取餐時間：</p>
    <p id="assignedSlotText" class="text-2xl font-bold mt-1"></p>
    <p class="text-slate-700 mt-3">取餐號碼：</p>
    <p id="pickupNoText" class="text-3xl font-extrabold tracking-wider mt-1"></p>
    <div class="mt-4 flex justify-end">
      <button id="closeSuccess" class="btn px-4 py-2 border border-slate-300 hover:bg-slate-100">關閉</button>
    </div>
  </div>
</div>

<footer class="border-t border-slate-200 mt-12">
  <div class="mx-auto container-slim px-4 py-6 text-sm text-slate-600">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>© <span id="year"></span> 行家牛排</div>
    </div>
  </div>
</footer>

<script>
/* === 只需改這兩個設定 === */
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbyYevyw5yXhxRNz8nKq6ZMyfJQ37XkRO6vGPWiWTN7_Zw01pbcgKw6YxrsVUA3CYefT/exec';
const API_KEY  = 'steak';

/* === 小工具 & 狀態 === */
const el = s => document.querySelector(s);
const money = n => '$' + Number(n||0).toLocaleString('zh-Hant');
const state = { cart: [] };
const onlyHHmm = (s) => {
  const m = String(s || '').match(/(\d{2}):(\d{2})/);
  return m ? `${m[1]}:${m[2]}` : '';
};

/* === 醬汁 / 主食 / 加點（勾選） === */
const SAUCES  = ["黑胡椒醬","蘑菇醬","綜合醬","蘑菇+玫瑰鹽","黑胡椒+玫瑰鹽","都不要醬+玫瑰鹽"];
const STAPLES = ["牛排麵條",
                 "通心麵",
                 // "飯",
                 "麵換蛋"];
const ADDONS  = [
  // { id:"加飯", price:10 },
  { id:"加麵", price:10 },
  { id:"加蛋", price:15 },
  { id:"加培根", price:40 }
];

/* === 菜單 === */
const MENU = {
  pork: [
    { id:"嚴選豬排",       name:"嚴選豬排",       price:150 },
    { id:"嚴選厚切豬排",   name:"嚴選厚切豬排",   price:200 },
    { id:"厚切梅花豬排",   name:"厚切梅花豬排",   price:200 },
    { id:"香煎培根豬排",   name:"香煎培根豬排",   price:190 },
    { id:"彈牙松板豬排",   name:"彈牙松板豬排",   price:220 },
    { id:"香煎風味培根排", name:"香煎風味培根排", price:150 },
  ],
  beef: [
    { id:"薄片牛排",       name:"薄片牛排",              price:150 },
    { id:"香煎培根牛排",       name:"香煎培根牛排",       price:190 },
    { id:"厚切沙朗牛排",       name:"厚切沙朗牛排",       price:210 },
    { id:"厚切板腱牛排",       name:"厚切板腱牛排",       price:220 },
    { id:"厚切無骨牛小排",     name:"厚切無骨牛小排",     price:220 },
    { id:"厚切嫩肩牛排",   name:"厚切嫩肩牛排",          price:220 },
    { id:"8盎司厚切翼板牛排",  name:"8盎司厚切翼板牛排",  price:350 },
    { id:"16盎司厚切肩胛牛排", name:"16盎司厚切肩胛牛排", price:450 },
  ],
  chicken: [
    { id:"香煎雞胸排",     name:"香煎雞胸排",     price:170 },
    { id:"香煎培根雞胸排", name:"香煎培根雞胸排", price:210 },
    { id:"香煎雞腿排",     name:"香煎雞腿排",     price:170 },
    { id:"香煎培根雞腿排", name:"香煎培根雞腿排", price:210 },
  ],
  seafood: [
    { id:"鮮嫩鮭魚排", name:"鮮嫩鮭魚排", price:220 },
    { id:"阿根廷魷魚", name:"阿根廷魷魚", price:220 },
  ],
  // combo: [
  //   { id:"嚴選豬+薄片牛",  name:"嚴選豬+薄片牛", price:240 },
  //   { id:"嚴選豬+香煎雞腿", name:"嚴選豬+香煎雞腿", price:260 },
  //   { id:"豬+雞胸",       name:"豬+雞胸",       price:250 },
  //   { id:"薄片牛+香煎雞胸",       name:"薄片牛+香煎雞胸",       price:260 },
  //   { id:"薄片牛+香煎雞腿",       name:"薄片牛+香煎雞腿",       price:260 },
  //   { id:"厚沙朗+嚴選豬",     name:"厚沙朗+嚴選豬",     price:300 },
  //   { id:"梅花豬+雞腿",   name:"梅花豬+雞腿",   price:290 },
  //   { id:"厚豬+雞腿",     name:"厚豬+雞腿",     price:290 },
  //   { id:"魷魚+豬",       name:"魷魚+豬",       price:300 },
  //   { id:"香煎雞腿+阿根廷魷魚",     name:"香煎雞腿+阿根廷魷魚",     price:330 },
  //   { id:"厚沙朗+厚豬",   name:"厚沙朗+厚豬",   price:320 },
  //   { id:"牛小排+鮭魚",   name:"牛小排+鮭魚",   price:360 },
  //   { id:"厚菲力+厚板腱", name:"厚菲力+厚板腱", price:360 },
  //   { id:"松板豬+魷魚",   name:"松板豬+魷魚",   price:370 },
  //   { id:"豬排+雞腿",   name:"豬排+雞腿",   price:250 },
  //   { id:"厚梅花豬+魷魚",   name:"厚梅花豬+魷魚",   price:340 },
  //   { id:"厚梅花豬+厚切豬",   name:"厚梅花豬+厚切豬",   price:320 },
  //   { id:"牛排+鮭魚",   name:"牛排+鮭魚",   price:300 },
  //   { id:"嚴選豬+鮮嫩鮭魚",   name:"嚴選豬+鮮嫩鮭魚",   price:310 },
  // ],
  combo: [
    { id:"嚴選豬+薄片牛",         name:"嚴選豬+薄片牛",         price:240 },
    { id:"嚴選豬+香煎雞腿",       name:"嚴選豬+香煎雞腿",       price:260 },
    { id:"薄片牛+香煎雞腿",       name:"薄片牛+香煎雞腿",       price:260 },
    { id:"薄片牛+香煎雞胸",       name:"薄片牛+香煎雞胸",       price:260 },
    { id:"嚴選豬+厚切沙朗",       name:"嚴選豬+厚切沙朗",       price:300 },
    { id:"嚴選豬+鮮嫩鮭魚",       name:"嚴選豬+鮮嫩鮭魚",       price:310 },
    { id:"香煎雞腿+阿根廷魷魚",   name:"香煎雞腿+阿根廷魷魚",   price:330 },
    { id:"松板豬+香煎雞腿",       name:"松板豬+香煎雞腿",       price:330 },
    { id:"厚切豬+厚切板腱",       name:"厚切豬+厚切板腱",       price:360 },
    { id:"厚切梅花+厚切嫩肩",     name:"厚切梅花+厚切嫩肩",     price:360 },
    { id:"厚切梅花+阿根廷魷魚",   name:"厚切梅花+阿根廷魷魚",   price:360 },
    { id:"厚切沙朗+厚切板腱",     name:"厚切沙朗+厚切板腱",     price:370 },
    { id:"厚切沙朗+厚切嫩肩",     name:"厚切沙朗+厚切嫩肩",     price:370 },
    { id:"松板豬+厚切板腱",       name:"松板豬+厚切板腱",       price:380 },
    { id:"厚切嫩肩+厚切板腱",     name:"厚切嫩肩+厚切板腱",     price:380 },
  ],

  sides: [
    { id:"鐵板麵",     name:"鐵板麵",     price:80, noStaple:true },
    // { id:"鐵板飯",     name:"鐵板飯",     price:80, noStaple:true },
    { id:"鐵板通心麵", name:"鐵板通心麵", price:80, noStaple:true },
  ],
};

/* === Render：分類卡片 === */
function renderCategory(list, targetId){
  const root = el(targetId); root.innerHTML='';
  list.forEach(item=>{
    const card=document.createElement('div');
    card.className='card bg-white p-4 flex flex-col';
    card.innerHTML=`
      <div class="flex items-start justify-between gap-3">
        <div><h3 class="text-lg font-semibold">${item.name}</h3></div>
        <div class="text-right font-semibold mono">${money(item.price)}</div>
      </div>
      <div class="mt-4 flex justify-end">
        <button class="btn px-4 py-2 bg-slate-900 text-white hover:bg-slate-800">選擇</button>
      </div>`;
    card.querySelector('button').addEventListener('click', ()=> openItemModal(item));
    root.appendChild(card);
  });
}

/* === Modal（選醬汁 / 主食 / 加點 / 數量 / 備註） === */
let currentItem = null;
function openItemModal(item){
  currentItem = item;
  document.body.classList.add('overflow-hidden');
  el('#pmTitle').textContent = item.name;

  // 醬汁
  const sauceSel = el('#pmSauce'); sauceSel.innerHTML='';
  SAUCES.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sauceSel.appendChild(o); });

  // 主食（可隱藏）
  const stapleWrap = el('#pmStapleWrap');
  const stapleSel  = el('#pmStaple');
  if (stapleSel) stapleSel.innerHTML='';
  const isNoStaple = !!item.noStaple;
  if (stapleWrap) stapleWrap.style.display = isNoStaple ? 'none' : '';
  if (!isNoStaple) {
    STAPLES.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; stapleSel.appendChild(o); });
  }

  // 加點（checkbox）
  const ex = el('#pmAddons'); ex.innerHTML='';
  ADDONS.forEach((a,idx)=>{
    const id = `addon_${idx}`;
    const row = document.createElement('label');
    row.className='flex items-center justify-between gap-3 border border-slate-200 rounded-lg px-3 py-2 cursor-pointer';
    row.innerHTML = `
      <div class="flex items-center gap-2">
        <input type="checkbox" id="${id}" class="addonChk w-4 h-4">
        <span class="font-medium">${a.id}</span>
      </div>
      <div class="text-sm mono">${money(a.price)}</div>`;
    ex.appendChild(row);
  });

  // 備註（本品項）
  const pmRemark = el('#pmRemark');
  if (pmRemark) pmRemark.value = '';

  // 數量初始與小計
  const qtyInput = el('#pmQty');
  qtyInput.value = 1;
  updatePmSubtotal();

  el('#pmDec').onclick = ()=>{ qtyInput.value = Math.max(1, (parseInt(qtyInput.value)||1) - 1); updatePmSubtotal(); };
  el('#pmInc').onclick = ()=>{ qtyInput.value = (parseInt(qtyInput.value)||1) + 1; updatePmSubtotal(); };
  qtyInput.oninput = updatePmSubtotal;

  el('#pmAddons').onchange = updatePmSubtotal;
  el('#pmSauce').onchange  = updatePmSubtotal;
  if (!isNoStaple) el('#pmStaple').onchange = updatePmSubtotal;

  // 加入購物車
  el('#pmAdd').onclick = ()=>{
    const qty    = Math.max(1, parseInt(qtyInput.value)||1);
    const sauce  = el('#pmSauce').value;
    const staple = isNoStaple ? '' : el('#pmStaple').value;
    const remark = (el('#pmRemark')?.value || '').trim();
    const selectedAddons = [];
    el('#pmAddons').querySelectorAll('.addonChk').forEach((chk, i)=>{
      if(chk.checked) selectedAddons.push(ADDONS[i]);
    });
    addToCart({ item: currentItem, sauce, staple, addons: selectedAddons, qty, remark, noStaple: isNoStaple });
  };

  el('#itemModal').classList.remove('hidden');
}
function closeItemModal(){
  el('#itemModal').classList.add('hidden');
  document.body.classList.remove('overflow-hidden');
  currentItem = null;
}
function updatePmSubtotal(){
  if(!currentItem) return;
  const qty = Math.max(1, parseInt(el('#pmQty').value)||1);
  const addonSum = Array.from(el('#pmAddons').querySelectorAll('.addonChk'))
    .reduce((s,chk,i)=> s + (chk.checked ? ADDONS[i].price : 0), 0);
  const subtotal = currentItem.price * qty + addonSum * qty; // 加點為每份計價
  el('#pmSubtotal').textContent = money(subtotal);
}

/* === Cart === */
function addToCart(bundle){
  state.cart.push({ type:'meal', ...bundle });
  renderCart(); closeItemModal();
}
function removeCartEntry(index){ state.cart.splice(index,1); renderCart(); }
function cartTotal(){
  return state.cart.reduce((sum,e)=>{
    if(e.type==='meal'){
      const addonSum = (e.addons||[]).reduce((s,a)=> s+a.price, 0);
      return sum + e.item.price*e.qty + addonSum*e.qty;
    }
    return sum;
  }, 0);
}
function renderCart(){
  const root=el('#cartItems'); root.innerHTML='';
  if(state.cart.length===0){ root.innerHTML='<div class="text-slate-500">購物車目前沒有商品。</div>'; }
  state.cart.forEach((e, idx)=>{
    const addonText = (e.addons||[]).length ? e.addons.map(a=>a.id).join('、') : '(無加點)';
    const linePrice = e.item.price*e.qty + (e.addons||[]).reduce((s,a)=> s+a.price,0)*e.qty;
    const div=document.createElement('div');
    div.className='card bg-white p-4';
    div.innerHTML=`
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="font-medium">
            ${e.item.name} ｜ 醬汁：${e.sauce}${e.noStaple ? '' : ` ｜ 副食：${e.staple}`}
          </div>
          <div class="text-sm text-slate-700 mt-1">加點：${addonText}</div>
          <div class="text-sm text-slate-700 mt-1">備註：${e.remark ? e.remark : '(無)'}</div>
          <div class="text-sm text-slate-600 mt-1">
            數量 ×
            <input type="number" min="1" value="${e.qty}" class="lineQty w-16 text-center border border-slate-300 rounded-lg py-1 mx-1 bg-white text-slate-900">
          </div>
        </div>
        <div class="shrink-0 text-right">
          <div class="font-semibold mono">${money(linePrice)}</div>
          <button class="remove btn mt-2 px-3 py-2 border border-slate-300 hover:bg-slate-100">移除</button>
        </div>
      </div>`;
    div.querySelector('.lineQty').addEventListener('input', ev=>{
      let v=parseInt(ev.target.value)||1; if(v<1)v=1; e.qty=v; renderCart();
    });
    div.querySelector('.remove').addEventListener('click', ()=> removeCartEntry(idx));
    root.appendChild(div);
  });
  el('#cartTotal').textContent=money(cartTotal());
}

/* === API（移除 Content-Type，避免 CORS 預檢） === */
async function apiCreate(order){
  const body = { apiKey: API_KEY, action: 'create', order };
  const r = await fetch(ENDPOINT, {
    method: 'POST',
    body: JSON.stringify(body)
  });
  const t = await r.text();
  let d; try { d = JSON.parse(t); } catch { throw new Error('bad_json:' + t.slice(0, 200)); }
  return d;
}

/* === Submit === */
async function onSubmitOrder(e){
  e.preventDefault();
  const btn=e.target.querySelector('button[type="submit"]');
  const setBusy=b=>{ btn.disabled=b; btn.textContent=b?'送出中…':'送出訂單'; };
  const showErr=m=>el('#formError').textContent=m;
  setBusy(true); showErr('');
  try{
    if(state.cart.length===0){ showErr('購物車尚無商品。'); return; }
    const name=el('#customerName').value.trim();
    const phone=el('#customerPhone').value.trim();
    if(!name||!phone){ showErr('請完整填寫姓名與電話。'); return; }

    // 組訂單品項（名稱含選項、加點、備註；單點副食不拼副食）
    const items = state.cart.map(e=>{
      const addonText  = (e.addons||[]).length ? '｜加點：'+e.addons.map(a=>a.id).join('、') : '';
      const staplePart = e.noStaple ? '' : `｜副食：${e.staple}`;
      const remarkPart = '｜備註：' + (e.remark || '');
      const nameWith   = `${e.item.name}｜醬汁：${e.sauce}${staplePart}${addonText}${remarkPart}`;
      const unitPrice  = e.item.price + (e.addons||[]).reduce((s,a)=> s+a.price, 0);
      return { id:e.item.id, name:nameWith, price:unitPrice, qty:e.qty };
    });
    const subtotal = items.reduce((s,it)=> s + it.price*it.qty, 0);

    // 交由後端決定取餐時間（或前端選擇的 requestedPickup）
    const order={
      id:'O'+Date.now(),
      customer:{ name, phone },
      items, subtotal, total:subtotal,
      createdAt:new Date().toISOString(),
      source:'web-customer'
    };

    const resp=await apiCreate(order);
    if(!resp.ok){
      const friendly = resp.message
        || (resp.error==='paused'        ? '目前已停止接單。'
            : resp.error==='order_closed'? '目前非下單時段（可下單 00:00–22:00）。'
            : `送單失敗：${resp.error||'create_failed'}`);
      showErr(friendly);
      return;
    }

    state.cart=[]; renderCart();

    // 成功視窗只顯示「幾點幾分」
    el('#assignedSlotText').textContent = onlyHHmm(resp.assignedPickupTime || '');
    el('#pickupNoText').textContent = resp.pickupNo || '';
    el('#successModal').classList.remove('hidden');

  }catch(err){
    el('#formError').textContent = '送單失敗：'+err.message;
  }finally{ setBusy(false); }
}

/* === 公告視窗控制 === */
function openNotice(){
  document.body.classList.add('overflow-hidden');
  el('#noticeModal').classList.remove('hidden');
}
function closeNotice(){
  el('#noticeModal').classList.add('hidden');
  document.body.classList.remove('overflow-hidden');
}

/* === Init === */
document.addEventListener('DOMContentLoaded',()=>{
  el('#year').textContent=new Date().getFullYear();
  renderCategory(MENU.pork,'#porkList');
  renderCategory(MENU.beef,'#beefList');
  renderCategory(MENU.chicken,'#chickenList');
  renderCategory(MENU.seafood,'#seafoodList');
  renderCategory(MENU.combo,'#comboList');
  renderCategory(MENU.sides,'#sidesList');
  renderCart();
  el('#clearCart').addEventListener('click',()=>{state.cart=[];renderCart();});
  el('#checkoutForm').addEventListener('submit',onSubmitOrder);
  el('#closeSuccess').addEventListener('click',()=>el('#successModal').classList.add('hidden'));

  // 公告：頁面載入後立即顯示
  openNotice();
  el('#closeNotice').addEventListener('click', closeNotice);
});
</script>

<!-- 追加：自選取餐時段（17:00–22:00，每 15 分；不可早於現在；未選則由系統安排下一個可取餐時間） -->
<script>
/* 營業參數（取餐時段） */
const SLOT_OPEN_HOUR  = 17;
const SLOT_CLOSE_HOUR = 22;
const SLOT_STEP_MIN   = 15;

/* 工具 */
const _pad2 = n => (n<10?'0':'')+n;
const _fmtHHmm = d => `${_pad2(d.getHours())}:${_pad2(d.getMinutes())}`;
function _ceilToNextStep(d, step=SLOT_STEP_MIN){
  const out = new Date(d);
  const m = out.getMinutes();
  const floored = m - (m % step);
  out.setMinutes(floored, 0, 0);
  if (out.getTime() < d.getTime()) out.setMinutes(out.getMinutes() + step);
  return out;
}
function _buildTodaySlots(now){
  const start = new Date(now); start.setHours(SLOT_OPEN_HOUR, 0, 0, 0);
  const last  = new Date(now); last.setHours(SLOT_CLOSE_HOUR-1, 45, 0, 0);
  const slots = [];
  for (let t=new Date(start); t<=last; t.setMinutes(t.getMinutes()+SLOT_STEP_MIN)) {
    slots.push(new Date(t));
  }
  return slots;
}

/* 動態插入取餐時段欄位（不改動原有節點，只新增） */
(function injectPickupField(){
  const form = document.querySelector('#checkoutForm');
  if (!form) return;
  const submitBtn = form.querySelector('button[type="submit"]');
  const holder = document.createElement('div');
  holder.innerHTML = `
    <div class="mt-2">
      <label class="text-sm text-slate-600">取餐時段（選填）</label>
      <select id="pickupSelect"
              class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900"></select>
      <p id="pickupHint" class="text-xs text-slate-500 mt-1"></p>
    </div>
  `;
  form.insertBefore(holder, submitBtn);

  function refreshOptions(){
    const sel  = document.querySelector('#pickupSelect');
    const hint = document.querySelector('#pickupHint');
    if (!sel) return;

    const now = new Date();
    const nextAllowed = _ceilToNextStep(now, SLOT_STEP_MIN);
    const slots = _buildTodaySlots(now);

    const prev = sel.value;
    sel.innerHTML = '';

    // 自動選項（未選時，由後端自動排至下一個可取餐時間）
    const optAuto = document.createElement('option');
    optAuto.value = '';
    optAuto.textContent = '自動（由系統安排下一個可取餐時間）';
    sel.appendChild(optAuto);

    let firstEnabled = '';
    for (const s of slots) {
      const o = document.createElement('option');
      o.value = _fmtHHmm(s);
      o.textContent = _fmtHHmm(s);
      if (s.getTime() < nextAllowed.getTime()) {
        o.disabled = true;
        o.textContent += '（不可選）';
      } else if (!firstEnabled) firstEnabled = _fmtHHmm(s);
      sel.appendChild(o);
    }

    if ([...sel.options].some(op => op.value === prev && !op.disabled)) {
      sel.value = prev;
    } else {
      sel.value = '';
    }

    hint.textContent = firstEnabled
      ? `目前最早可選：${firstEnabled}`
      : '今日可選時段已結束；未選時段照送出，系統會安排下一個可取餐時間（通常為下一個營業日 17:00）。';
  }

  refreshOptions();
  setInterval(refreshOptions, 60000);
})();

/* 包裝 apiCreate：若使用者選了時段，就一併帶上 requestedPickup（HH:mm） */
(function wrapApiCreate(){
  if (typeof apiCreate !== 'function') return;
  const __orig = apiCreate;
  window.apiCreate = async function(order){
    try{
      const sel = document.querySelector('#pickupSelect');
      const val = sel ? String(sel.value || '') : '';
      if (val) order = { ...order, requestedPickup: val };
    }catch(e){}
    return __orig(order);
  };
})();
</script>

<!-- 選項彈窗 -->
<div id="itemModal" class="fixed inset-0 z-40 hidden scroll-y">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative z-10 min-h-full flex items-start justify-center py-6 px-3">
    <div class="w-full max-w-2xl card bg-white p-6 max-h-[85vh] scroll-y">
      <div class="flex items-start justify-between">
        <div class="min-w-0">
          <h3 id="pmTitle" class="text-xl font-semibold"></h3>
        </div>
        <button onclick="closeItemModal()" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">關閉</button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div>
          <label class="text-sm text-slate-600">醬汁</label>
          <select id="pmSauce" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900"></select>
        </div>
        <div id="pmStapleWrap">
          <label class="text-sm text-slate-600">副食</label>
          <select id="pmStaple" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900"></select>
        </div>
      </div>

      <div class="mt-5">
        <label class="text-sm text-slate-600">加點</label>
        <div id="pmAddons" class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-3"></div>
      </div>

      <div class="mt-5">
        <label class="text-sm text-slate-600">備註（本品項，選填）</label>
        <textarea id="pmRemark" rows="2"
          class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900"
          placeholder=""></textarea>
      </div>

      <div class="mt-5">
        <label class="text-sm text-slate-600">數量</label>
        <div class="mt-1 flex items-center gap-2">
          <button id="pmDec" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">-</button>
          <input id="pmQty" type="number" min="1" value="1" class="w-20 text-center border border-slate-300 rounded-xl py-2 bg-white text-slate-900" />
          <button id="pmInc" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">+</button>
        </div>
      </div>

      <div class="mt-6 flex items-center justify-between">
        <div class="text-lg">小計：<span id="pmSubtotal" class="font-semibold mono">$0</span></div>
        <button id="pmAdd" class="btn px-4 py-2 bg-slate-900 text-white hover:bg-slate-800">加入購物車</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>
