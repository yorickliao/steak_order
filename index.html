<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>行家牛排 線上點餐</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light">
  <style>
    .card{border-radius:1rem}.btn{border-radius:1rem}.badge{border-radius:999px}
    .container-slim{max-width:1200px}.mono{font-variant-numeric:tabular-nums}
    input,select,textarea,option,button{color-scheme:light}
    input,select,textarea{background:#fff!important;color:#0f172a!important;-webkit-text-fill-color:#0f172a;border-color:#cbd5e1}
    select option{background:#fff;color:#0f172a}
    .scroll-y{overflow-y:auto;-webkit-overflow-scrolling:touch}
  </style>
</head>

<body class="bg-slate-50 text-slate-900 selection:bg-slate-200 selection:text-slate-900">
<header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="mx-auto container-slim px-4 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-slate-900 text-white rounded-xl grid place-items-center text-lg font-bold select-none">店</div>
      <div>
        <div class="text-xl font-semibold">行家牛排 線上點餐</div>
      </div>
    </div>
    <a href="#cart" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">購物車</a>
  </div>
</header>

<main class="mx-auto container-slim px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
  <section class="lg:col-span-2 space-y-8">
    <div class="space-y-3">
      <h2 class="text-lg font-semibold">豬肉</h2>
      <div id="porkList" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </div>
    <div class="space-y-3">
      <h2 class="text-lg font-semibold">牛肉</h2>
      <div id="beefList" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </div>
    <div class="space-y-3">
      <h2 class="text-lg font-semibold">雞肉</h2>
      <div id="chickenList" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </div>
    <div class="space-y-3">
      <h2 class="text-lg font-semibold">海鮮</h2>
      <div id="seafoodList" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </div>
    <div class="space-y-3">
      <h2 class="text-lg font-semibold">雙拼</h2>
      <div id="comboList" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </div>
  </section>

  <aside id="cart"
    class="space-y-6 lg:sticky lg:top-[88px] lg:max-h-[calc(100vh-120px)] lg:overflow-y-auto lg:pr-1"
    style="-webkit-overflow-scrolling: touch;">
    <div class="card bg-white p-5">
      <h2 class="text-lg font-semibold mb-4">購物車</h2>
      <div id="cartItems" class="space-y-3"></div>
      <div class="border-t pt-4 mt-4 flex items-center justify-between text-lg font-semibold">
        <div>總計</div>
        <div id="cartTotal" class="mono">$0</div>
      </div>
      <button id="clearCart" class="mt-3 w-full btn px-4 py-2 border border-slate-300 hover:bg-slate-100">清空購物車</button>
    </div>

    <div class="card bg-white p-5">
      <h2 class="text-lg font-semibold mb-4">取餐資訊</h2>
      <form id="checkoutForm" class="space-y-4" autocomplete="off">
        <div>
          <label class="text-sm text-slate-600">姓名</label>
          <input required id="customerName" type="text"
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900" />
        </div>
        <div>
          <label class="text-sm text-slate-600">電話</label>
          <input required id="customerPhone" type="tel" pattern="[0-9\-+\s]{8,}" placeholder="09xx-xxx-xxx"
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900" />
        </div>
        <button type="submit" class="w-full btn px-4 py-3 bg-slate-900 text-white hover:bg-slate-800">送出訂單</button>
        <p id="formError" class="text-sm text-red-600"></p>
      </form>
    </div>
  </aside>
</main>

<!-- 成功視窗 -->
<div id="successModal" class="fixed inset-0 z-40 hidden">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative z-10 mx-auto mt-24 w-[92%] max-w-xl card bg-white p-6">
    <h3 class="text-xl font-semibold mb-2">下單成功</h3>
    <p class="text-slate-700">取餐時間：</p>
    <p id="assignedSlotText" class="text-2xl font-bold mt-1"></p>
    <p class="text-slate-700 mt-3">取餐號碼：</p>
    <p id="pickupNoText" class="text-3xl font-extrabold tracking-wider mt-1"></p>
    <div class="mt-4 flex justify-end">
      <button id="closeSuccess" class="btn px-4 py-2 border border-slate-300 hover:bg-slate-100">關閉</button>
    </div>
  </div>
</div>

<footer class="border-t border-slate-200 mt-12">
  <div class="mx-auto container-slim px-4 py-6 text-sm text-slate-600">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>© <span id="year"></span> 行家牛排</div>
    </div>
  </div>
</footer>

<script>
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxh3LdPhOqe3VPX0Td7tAn3h6kzUARE3w7BvIiww3bGUtCHOFXRnmJdmYLUk8EeyX1X/exec';
const API_KEY  = 'steak';
const el = s => document.querySelector(s);
const money = n => '$' + Number(n||0).toLocaleString('zh-Hant');
const state = { cart: [] };

// === 商品資料（之後可補充） ===
const MENU = {
  pork:    [{ id:"豬排", name:"豬排", price:200 }],
  beef:    [{ id:"牛排", name:"牛排", price:300 }],
  chicken: [{ id:"雞腿排", name:"雞腿排", price:180 }],
  seafood: [{ id:"鮭魚排", name:"鮭魚排", price:280 }],
  combo:   [{ id:"豬牛雙拼", name:"豬牛雙拼", price:400 }]
};

// === Render function ===
function renderCategory(list, targetId){
  const root = el(targetId); root.innerHTML='';
  list.forEach(item=>{
    const card=document.createElement('div');
    card.className='card bg-white p-4 flex flex-col';
    card.innerHTML=`
      <div class="flex items-start justify-between gap-3">
        <div><h3 class="text-lg font-semibold">${item.name}</h3></div>
        <div class="text-right font-semibold mono">${money(item.price)}</div>
      </div>
      <div class="mt-4 flex justify-end">
        <button class="btn px-4 py-2 bg-slate-900 text-white hover:bg-slate-800">加入</button>
      </div>`;
    card.querySelector('button').addEventListener('click', ()=> addToCart(item));
    root.appendChild(card);
  });
}

function addToCart(item){ state.cart.push({ ...item, qty:1 }); renderCart(); }
function removeCartEntry(index){ state.cart.splice(index,1); renderCart(); }
function cartTotal(){ return state.cart.reduce((s,it)=>s+it.price*it.qty,0); }

function renderCart(){
  const root=el('#cartItems'); root.innerHTML='';
  if(state.cart.length===0){ root.innerHTML='<div class="text-slate-500">購物車目前沒有商品。</div>'; }
  state.cart.forEach((it,idx)=>{
    const price=it.price*it.qty;
    const div=document.createElement('div');
    div.className='card bg-white p-4 flex items-center justify-between gap-3';
    div.innerHTML=`
      <div class="min-w-0">
        <div class="font-medium">${it.name}</div>
        <div class="text-sm text-slate-600">
          單價 ${money(it.price)} ×
          <input type="number" min="1" value="${it.qty}" class="lineQty w-16 text-center border border-slate-300 rounded-lg py-1 mx-1 bg-white text-slate-900">
          = <span class="mono">${money(price)}</span>
        </div>
      </div>
      <button class="remove btn px-3 py-2 border border-slate-300 hover:bg-slate-100">移除</button>`;
    div.querySelector('.lineQty').addEventListener('input', ev=>{
      let v=parseInt(ev.target.value)||1; if(v<1)v=1; it.qty=v; renderCart();
    });
    div.querySelector('.remove').addEventListener('click', ()=> removeCartEntry(idx));
    root.appendChild(div);
  });
  el('#cartTotal').textContent=money(cartTotal());
}

// === API ===
async function apiCreate(order){
  const body={ apiKey:API_KEY, action:'create', order };
  const r=await fetch(ENDPOINT,{ method:'POST', body:JSON.stringify(body) });
  const t=await r.text(); let d; try{ d=JSON.parse(t) }catch{ throw new Error('bad_json:'+t.slice(0,200)); }
  return d;
}

// === Submit ===
async function onSubmitOrder(e){
  e.preventDefault();
  const btn=e.target.querySelector('button[type="submit"]');
  const setBusy=b=>{ btn.disabled=b; btn.textContent=b?'送出中…':'送出訂單'; };
  const showErr=m=>el('#formError').textContent=m;
  setBusy(true); showErr('');
  try{
    if(state.cart.length===0){ showErr('購物車尚無商品。'); return; }
    const name=el('#customerName').value.trim();
    const phone=el('#customerPhone').value.trim();
    if(!name||!phone){ showErr('請完整填寫姓名與電話。'); return; }

    const items=state.cart.map(it=>({ id:it.id, name:it.name, price:it.price, qty:it.qty }));
    const subtotal=items.reduce((s,it)=>s+it.price*it.qty,0);

    // 下單時間 +15 分鐘
    const pickupDate=new Date(Date.now()+15*60000);
    const pickupTime=pickupDate.toLocaleString('zh-TW',{hour12:false});

    const order={
      id:'O'+Date.now(),
      customer:{ name, phone },
      pickupTime,
      items, subtotal, total:subtotal,
      createdAt:new Date().toISOString(),
      source:'web-customer'
    };

    const resp=await apiCreate(order);
    if(!resp.ok){ showErr(`送單失敗：${resp.error||'create_failed'}`); return; }

    state.cart=[]; renderCart();
    el('#assignedSlotText').textContent=pickupTime;
    el('#pickupNoText').textContent=resp.pickupNo||'';
    el('#successModal').classList.remove('hidden');
  }catch(err){
    showErr('送單失敗：'+err.message);
  }finally{ setBusy(false); }
}

// === Init ===
document.addEventListener('DOMContentLoaded',()=>{
  el('#year').textContent=new Date().getFullYear();
  renderCategory(MENU.pork,'#porkList');
  renderCategory(MENU.beef,'#beefList');
  renderCategory(MENU.chicken,'#chickenList');
  renderCategory(MENU.seafood,'#seafoodList');
  renderCategory(MENU.combo,'#comboList');
  renderCart();
  el('#clearCart').addEventListener('click',()=>{state.cart=[];renderCart();});
  el('#checkoutForm').addEventListener('submit',onSubmitOrder);
  el('#closeSuccess').addEventListener('click',()=>el('#successModal').classList.add('hidden'));
});
</script>
</body>
</html>
