<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>326臭臭鍋 線上點餐（極簡版）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light">
  <style>
    .card{border-radius:1rem}.btn{border-radius:1rem}.badge{border-radius:999px}
    .container-slim{max-width:1200px}.mono{font-variant-numeric:tabular-nums}
    input,select,textarea,option,button{color-scheme:light}
    input,select,textarea{background:#fff!important;color:#0f172a!important;-webkit-text-fill-color:#0f172a;border-color:#cbd5e1}
    select option{background:#fff;color:#0f172a}
    .scroll-y{overflow-y:auto;-webkit-overflow-scrolling:touch}
  </style>
</head>

<body class="bg-slate-50 text-slate-900 selection:bg-slate-200 selection:text-slate-900">
<header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="mx-auto container-slim px-4 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-slate-900 text-white rounded-xl grid place-items-center text-lg font-bold select-none">店</div>
      <div>
        <div class="text-xl font-semibold">326臭臭鍋 線上點餐</div>
        <div class="text-xs text-slate-500">極簡入門版（無時段/限量/容量邏輯）</div>
      </div>
    </div>
    <a href="#cart" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">購物車</a>
  </div>
</header>

<main class="mx-auto container-slim px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
  <section class="lg:col-span-2 space-y-8">
    <div class="space-y-3">
      <h2 class="text-lg font-semibold">火鍋</h2>
      <div id="potList" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </div>

    <div class="space-y-3">
      <h2 class="text-lg font-semibold">主食</h2>
      <div id="sideList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>
  </section>

  <aside id="cart"
    class="space-y-6 lg:sticky lg:top-[88px] lg:max-h-[calc(100vh-120px)] lg:overflow-y-auto lg:pr-1"
    style="-webkit-overflow-scrolling: touch;">
    <div class="card bg-white p-5">
      <h2 class="text-lg font-semibold mb-4">購物車</h2>
      <div id="cartItems" class="space-y-3"></div>
      <div class="border-t pt-4 mt-4 flex items-center justify-between text-lg font-semibold">
        <div>總計</div>
        <div id="cartTotal" class="mono">$0</div>
      </div>
      <button id="clearCart" class="mt-3 w-full btn px-4 py-2 border border-slate-300 hover:bg-slate-100">清空購物車</button>
    </div>

    <div class="card bg-white p-5">
      <h2 class="text-lg font-semibold mb-4">取餐資訊</h2>
      <form id="checkoutForm" class="space-y-4" autocomplete="off">
        <div>
          <label class="text-sm text-slate-600">姓名</label>
          <input required id="customerName" type="text"
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900" />
        </div>
        <div>
          <label class="text-sm text-slate-600">電話</label>
          <input required id="customerPhone" type="tel" pattern="[0-9\-+\s]{8,}" placeholder="09xx-xxx-xxx"
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900" />
        </div>
        <div>
          <label class="text-sm text-slate-600">取餐時間（選填，自由輸入）</label>
          <input id="pickupTime" type="text" placeholder="例：今天 18:30 或 2025-09-20 18:30"
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900" />
        </div>
        <button type="submit" class="w-full btn px-4 py-3 bg-slate-900 text-white hover:bg-slate-800">送出訂單</button>
        <p id="formError" class="text-sm text-red-600"></p>
      </form>
    </div>
  </aside>
</main>

<!-- 成功視窗 -->
<div id="successModal" class="fixed inset-0 z-40 hidden">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative z-10 mx-auto mt-24 w-[92%] max-w-xl card bg-white p-6">
    <h3 class="text-xl font-semibold mb-2">下單成功</h3>
    <p class="text-slate-700">您填寫的取餐時間：</p>
    <p id="assignedSlotText" class="text-2xl font-bold mt-1"></p>
    <p class="text-slate-700 mt-3">您的取餐號碼（若後端有回傳）：</p>
    <p id="pickupNoText" class="text-3xl font-extrabold tracking-wider mt-1"></p>
    <div class="mt-4 flex justify-end">
      <button id="closeSuccess" class="btn px-4 py-2 border border-slate-300 hover:bg-slate-100">關閉</button>
    </div>
  </div>
</div>

<footer class="border-t border-slate-200 mt-12">
  <div class="mx-auto container-slim px-4 py-6 text-sm text-slate-600">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>© <span id="year"></span> 326臭臭鍋</div>
      <div class="text-xs text-slate-500">本頁面為示範用，之後再逐步加入限制/時段功能</div>
    </div>
  </div>
</footer>

<script>
/* ===== 你只需要改這兩個設定 ===== */
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzYWyHcNKnFVvdS4HXvvk-ob0JzMD9eTn3AkczLQ-p0WVpEeeFUJuofw1j6HBqucny2/exec';
const API_KEY  = 'steak';

/* ===== 商品資料（可自行增刪改） ===== */
const SPICE = ["無辣","小辣","中辣","大辣"];
const POTS = [
  { id:"臭臭鍋",   name:"臭臭鍋",   price:100, spiceOpts:SPICE },
  { id:"鴨血鍋",   name:"鴨血鍋",   price:90,  spiceOpts:SPICE },
  { id:"泡菜鍋",   name:"泡菜鍋",   price:110, spiceOpts:SPICE.filter(s=>s!=="無辣") },
  { id:"什錦鍋",   name:"什錦鍋",   price:130, spiceOpts:SPICE },
  { id:"腸旺鍋",   name:"腸旺鍋",   price:130, spiceOpts:SPICE },
  { id:"牛雜鍋",   name:"牛雜鍋",   price:150, spiceOpts:SPICE },
  { id:"大腸鴨血鍋", name:"大腸鴨血鍋", price:140, spiceOpts:SPICE },
];
const EXTRAS = [
  { id:"蟹肉棒", price:20 },{ id:"鱈魚丸", price:20 },{ id:"北海翅", price:20 },{ id:"鑫鑫腸", price:20 },
  { id:"金針菇", price:10 },{ id:"臭豆腐", price:20 },{ id:"貢丸", price:20 },{ id:"魚餃", price:20 },
  { id:"燕餃", price:20 },{ id:"黑輪", price:20 },{ id:"米血", price:20 },{ id:"鴨血", price:20 },
  { id:"蝦球", price:20 },{ id:"大腸", price:50 },{ id:"豆皮", price:30 },{ id:"豬肉", price:40 }
];
const SIDES = [{ id:"白飯", price:10 },{ id:"冬粉", price:10 },{ id:"科學麵", price:15 }];

/* ===== 小工具 ===== */
const el = s => document.querySelector(s);
const money = n => '$' + Number(n||0).toLocaleString('zh-Hant');

/* ===== 狀態 ===== */
const state = { cart: [] };

/* ===== Render：火鍋 ===== */
function renderPots(){
  const root = el('#potList'); root.innerHTML='';
  POTS.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'card bg-white p-4 flex flex-col';
    card.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div><h3 class="text-lg font-semibold">${p.name}</h3></div>
        <div class="text-right font-semibold mono">${money(p.price)}</div>
      </div>
      <div class="mt-3 text-sm text-slate-600">點選以選擇辣度、單點、備註</div>
      <div class="mt-4 flex justify-end">
        <button class="btn px-4 py-2 bg-slate-900 text-white hover:bg-slate-800">選擇</button>
      </div>`;
    card.querySelector('button').addEventListener('click', ()=> openPotModal(p));
    root.appendChild(card);
  });
}

/* ===== Render：主食 ===== */
function renderSides(){
  const root = el('#sideList'); root.innerHTML='';
  SIDES.forEach(s=>{
    const row = document.createElement('div');
    row.className = 'card bg-white p-4 flex items-center justify-between gap-3';
    row.innerHTML = `
      <div>
        <div class="font-medium">${s.id}</div>
        <div class="text-slate-600 mono">${money(s.price)}</div>
      </div>
      <div class="flex items-center gap-2">
        <button class="dec btn px-3 py-2 border border-slate-300 hover:bg-slate-100">-</button>
        <input type="number" min="0" value="0" class="qty w-16 text-center border border-slate-300 rounded-xl py-2 bg-white text-slate-900" />
        <button class="inc btn px-3 py-2 border border-slate-300 hover:bg-slate-100">+</button>
        <button class="add btn px-3 py-2 bg-slate-900 text-white hover:bg-slate-800">加入</button>
      </div>`;
    const qty = row.querySelector('.qty');
    row.querySelector('.dec').addEventListener('click', ()=> qty.value = Math.max(0,(parseInt(qty.value)||0)-1));
    row.querySelector('.inc').addEventListener('click', ()=> qty.value = Math.max(0,(parseInt(qty.value)||0)+1));
    row.querySelector('.add').addEventListener('click', ()=>{
      const n = parseInt(qty.value) || 0;
      if(n > 0) addSideToCart(s, n);
    });
    root.appendChild(row);
  });
}

/* ===== Modal（火鍋彈窗） ===== */
let pmCurrent = null;
function openPotModal(pot){
  pmCurrent = pot; document.body.classList.add('overflow-hidden');
  el('#pmTitle').textContent = pot.name;

  const sp = el('#pmSpice'); sp.innerHTML='';
  pot.spiceOpts.forEach(s => {
    const o=document.createElement('option'); o.value=s; o.textContent=s; sp.appendChild(o);
  });

  const ex = el('#pmExtras'); ex.innerHTML='';
  EXTRAS.forEach(e=>{
    const row=document.createElement('div');
    row.className='flex items-center justify-between gap-2 border border-slate-200 rounded-lg px-3 py-2';
    row.innerHTML=`
      <div class="min-w-0">
        <div class="font-medium">${e.id}</div>
        <div class="text-xs text-slate-600 mono">${money(e.price)}</div>
      </div>
      <div class="flex items-center gap-2">
        <button class="dec btn px-2 py-1 border border-slate-300 hover:bg-slate-100">-</button>
        <input type="number" min="0" value="0" class="exQty w-16 text-center border border-slate-300 rounded-xl py-1 bg-white text-slate-900" />
        <button class="inc btn px-2 py-1 border border-slate-300 hover:bg-slate-100">+</button>
      </div>`;
    const qty = row.querySelector('.exQty');
    row.querySelector('.dec').addEventListener('click', ()=> qty.value = Math.max(0,(parseInt(qty.value)||0)-1));
    row.querySelector('.inc').addEventListener('click', ()=> qty.value = Math.max(0,(parseInt(qty.value)||0)+1));
    qty.addEventListener('input', updatePmSubtotal);
    ex.appendChild(row);
  });

  el('#pmQty').value = 1;
  updatePmSubtotal();
  el('#pmAdd').onclick = ()=>{
    const qty = Math.max(1, parseInt(el('#pmQty').value)||1);
    const spice = el('#pmSpice').value;
    const note = el('#pmNote').value.trim();
    const extras = [];
    el('#pmExtras').querySelectorAll('.exQty').forEach((q,i)=>{
      const n = Math.max(0, parseInt(q.value)||0);
      if(n>0) extras.push({ id:EXTRAS[i].id, price:EXTRAS[i].price, qty:n });
    });
    addPotToCart({ pot: pmCurrent, spice, qty, note, extras });
  };

  el('#potModal').classList.remove('hidden');
}
function closePotModal(){ el('#potModal').classList.add('hidden'); document.body.classList.remove('overflow-hidden'); pmCurrent=null; }
function updatePmSubtotal(){
  if(!pmCurrent) return;
  const potQty = Math.max(1, parseInt(el('#pmQty').value)||1);
  let subtotal = pmCurrent.price * potQty;
  el('#pmExtras').querySelectorAll('.exQty').forEach((q,i)=>{ subtotal += EXTRAS[i].price * Math.max(0, parseInt(q.value)||0); });
  el('#pmSubtotal').textContent = money(subtotal);
}

/* ===== Cart ===== */
function addPotToCart(bundle){ state.cart.push({ type:'pot', ...bundle }); renderCart(); closePotModal(); }
function addSideToCart(side, qty){ state.cart.push({ type:'side', item:{ id:side.id, price:side.price, name:side.id }, qty }); renderCart(); }
function removeCartEntry(index){ state.cart.splice(index,1); renderCart(); }
function cartTotal(){
  return state.cart.reduce((sum,e)=> e.type==='pot'
    ? sum + e.pot.price*e.qty + e.extras.reduce((s,x)=> s + x.price*x.qty, 0)
    : sum + e.item.price*e.qty, 0);
}
function renderCart(){
  const root = el('#cartItems'); root.innerHTML='';
  if(state.cart.length===0){ root.innerHTML='<div class="text-slate-500">購物車目前沒有商品。</div>'; }
  state.cart.forEach((e, idx)=>{
    const div=document.createElement('div');
    if(e.type==='pot'){
      const extrasText = e.extras.filter(x=>x.qty>0).map(x=>`${x.id}×${x.qty}`).join('、') || '(無單點)';
      const noteText = e.note ? `｜備註：${e.note}` : '';
      const price = e.pot.price*e.qty + e.extras.reduce((s,x)=> s + x.price*x.qty,0);
      div.className='card bg-white p-4';
      div.innerHTML=`
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="font-medium">${e.pot.name}（${e.spice}） ×
              <input type="number" min="1" value="${e.qty}" class="lineQty w-16 text-center border border-slate-300 rounded-lg py-1 mx-1 bg-white text-slate-900">
            </div>
            <div class="text-sm text-slate-700 mt-1 break-words">${extrasText}</div>
            ${e.note?`<div class="text-xs text-slate-500 mt-1">${noteText}</div>`:''}
          </div>
          <div class="shrink-0 text-right">
            <div class="font-semibold mono">${money(price)}</div>
            <button class="remove btn mt-2 px-3 py-2 border border-slate-300 hover:bg-slate-100">移除</button>
          </div>
        </div>`;
      div.querySelector('.lineQty').addEventListener('input', ev=>{
        let v=parseInt(ev.target.value)||1; if(v<1)v=1;
        e.qty=v; renderCart();
      });
      div.querySelector('.remove').addEventListener('click', ()=> removeCartEntry(idx));
    }else{
      const price = e.item.price*e.qty;
      div.className='card bg-white p-4 flex items-center justify-between gap-3';
      div.innerHTML=`
        <div class="min-w-0">
          <div class="font-medium">${e.item.name}</div>
          <div class="text-sm text-slate-600">
            單價 ${money(e.item.price)} ×
            <input type="number" min="1" value="${e.qty}" class="lineQty w-16 text-center border border-slate-300 rounded-lg py-1 mx-1 bg-white text-slate-900">
            = <span class="mono">${money(price)}</span>
          </div>
        </div>
        <button class="remove btn px-3 py-2 border border-slate-300 hover:bg-slate-100">移除</button>`;
      div.querySelector('.lineQty').addEventListener('input', ev=>{ let v=parseInt(ev.target.value)||1; if(v<1)v=1; e.qty=v; renderCart(); });
      div.querySelector('.remove').addEventListener('click', ()=> removeCartEntry(idx));
    }
    root.appendChild(div);
  });
  el('#cartTotal').textContent = money(cartTotal());
}

/* ===== API ===== */
async function fetchWithTimeout(resource, options = {}, timeoutMs = 15000){
  const ctrl = new AbortController(); const timer=setTimeout(()=>ctrl.abort(), timeoutMs);
  try{ return await fetch(resource, { ...options, signal: ctrl.signal }); }
  finally{ clearTimeout(timer); }
}

// 送單（最簡單版）：直接把訂單丟到後端，無任何前端限制/演算法
async function apiCreate(order){
  const body = { apiKey:API_KEY, action:'create', order };
  const r = await fetchWithTimeout(ENDPOINT, { method:'POST', body: JSON.stringify(body) }, 20000);
  const t = await r.text(); let d; try{ d=JSON.parse(t) }catch{ throw new Error('bad_json:'+t.slice(0,200)) }
  return d;
}

/* ===== Submit ===== */
async function onSubmitOrder(e){
  e.preventDefault();
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const setBusy = b => { submitBtn.disabled=b; submitBtn.textContent = b ? '送出中…' : '送出訂單'; };
  const showErr = m => el('#formError').textContent = m;

  setBusy(true); showErr('');
  try{
    if(state.cart.length===0){ showErr('購物車尚無商品。'); return; }
    const name = el('#customerName').value.trim();
    const phone = el('#customerPhone').value.trim();
    const pickupTime = el('#pickupTime').value.trim();
    if(!name || !phone){ showErr('請完整填寫姓名與電話。'); return; }

    const items = [];
    state.cart.forEach(e=>{
      if(e.type==='pot'){
        const nameWith = `${e.pot.name}（${e.spice}）` + (e.note?`｜備註：${e.note}`:'');
        items.push({ id:e.pot.id, name:nameWith, price:e.pot.price, qty:e.qty });
        e.extras.filter(x=>x.qty>0).forEach(x=> items.push({ id:x.id, name:x.id, price:x.price, qty:x.qty }));
      }else{
        items.push({ id:e.item.id, name:e.item.name, price:e.item.price, qty:e.qty });
      }
    });
    const subtotal = items.reduce((s,it)=> s + it.price*it.qty, 0);

    const order = {
      id: 'O'+Date.now(),
      customer: { name, phone },
      pickupTime,                // 純文字交給後端處理
      items, subtotal, discount: 0, total: subtotal,
      createdAt: new Date().toISOString(),
      source: 'web-customer'
    };

    const resp = await apiCreate(order);
    if (!resp.ok) {
      const msg = resp.message ? `：${resp.message}` : '';
      showErr(`送單失敗：${resp.error || 'create_failed'}${msg}`);
      return;
    }

    // 成功
    state.cart = []; renderCart();
    el('#assignedSlotText').textContent = pickupTime || '(未填)';
    const pickupNo = (resp.pickupNo || (resp.order && resp.order.pickupNo)) || '';
    el('#pickupNoText').textContent = String(pickupNo);
    el('#successModal').classList.remove('hidden');

  }catch(err){
    console.error('submit_failed', err);
    const m = String(err && err.message || '');
    if (m.includes('timeout')) showErr('連線逾時，請再試一次。');
    else if (m.startsWith('bad_json')) showErr('伺服器回應格式異常：' + m.slice(8));
    else showErr('送單失敗：' + m);
  }finally{ setBusy(false); }
}

/* ===== Init ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  el('#year').textContent = new Date().getFullYear();
  renderPots();
  renderSides();
  renderCart();

  el('#clearCart').addEventListener('click', ()=>{ state.cart=[]; renderCart(); });
  el('#checkoutForm').addEventListener('submit', onSubmitOrder);
  el('#closeSuccess').addEventListener('click', ()=> el('#successModal').classList.add('hidden'));
});
</script>

<!-- 火鍋彈窗 -->
<div id="potModal" class="fixed inset-0 z-40 hidden scroll-y">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative z-10 min-h-full flex items-start justify-center py-6 px-3">
    <div class="w-full max-w-2xl card bg-white p-6 max-h-[85vh] scroll-y">
      <div class="flex items-start justify-between">
        <div class="min-w-0">
          <h3 id="pmTitle" class="text-xl font-semibold"></h3>
        </div>
        <button id="pmClose" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">關閉</button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div>
          <label class="text-sm text-slate-600">辣度</label>
          <select id="pmSpice" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900"></select>
        </div>
        <div>
          <label class="text-sm text-slate-600">數量</label>
          <div class="mt-1 flex items-center gap-2">
            <button id="pmDec" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">-</button>
            <input id="pmQty" type="number" min="1" value="1" class="w-20 text-center border border-slate-300 rounded-xl py-2 bg-white text-slate-900" />
            <button id="pmInc" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">+</button>
          </div>
        </div>
      </div>

      <div class="mt-5">
        <label class="text-sm text-slate-600">加點（單點）</label>
        <div id="pmExtras" class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-3"></div>
        <p class="text-xs text-slate-500 mt-1">單點數量不會跟著火鍋數量倍增，若需相同份數請自行調整。</p>
      </div>

      <div class="mt-5">
        <label class="text-sm text-slate-600">備註（選填）</label>
        <input id="pmNote" type="text" placeholder=""
               class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900" />
      </div>

      <div class="mt-6 flex items-center justify-between">
        <div class="text-lg">小計：<span id="pmSubtotal" class="font-semibold mono">$0</span></div>
        <button id="pmAdd" class="btn px-4 py-2 bg-slate-900 text-white hover:bg-slate-800">加入購物車</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>
